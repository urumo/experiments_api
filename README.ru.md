[![forthebadge](https://forthebadge.com/images/badges/made-with-ruby.svg)]()
[![forthebadge](https://forthebadge.com/images/badges/built-with-swag.svg)]()

[English readme](README.md).

# README

## Задача

Мобильное приложение при запуске генерирует некоторый уникальный ID клиента (который сохраняется между сессиями) и
запрашивает список экспериментов, добавляя HTTP-заголовок Device-Token. В ответ сервер отдаёт список экспериментов. Для
каждого эксперимента клиент получает:

* Ключ: имя эксперимента. В клиенте есть код, который будет изменять какое-то поведение в зависимости от значения этого
  ключа
* Значение: строка, одна из возможных опций (см. ниже)
*
    * Важно, чтобы девайс попадал в одну группу и всегда оставался в ней.

## Решение

Решение на самом деле довольно простое. Мы можем
использовать [алгоритм взвешенной случайной выборки](https://dev.to/jacktt/understanding-the-weighted-random-algorithm-581p#:~:text=Simple%20Explanation,in%20which%20this%20point%20falls.)
для решения всего.
Алгоритм довольно прост:

1. У нас есть список экспериментов с их весами (вероятностями).
2. Мы генерируем случайное число от 0 до суммы всех весов.
3. Мы проходим по списку экспериментов и вычитаем вес текущего эксперимента из случайного числа.
4. Если случайное число меньше 0, мы возвращаем текущий эксперимент.
5. Если случайное число больше 0, мы продолжаем итерацию.

Таким образом, мы можем получить случайный эксперимент с вероятностью, пропорциональной его весу, с небольшим разбросом.

Что касается отображения статистики, я решил использовать SQL [Представления](/db/views/distributions_v01.sql), чтобы
упростить запрос данных.
Таким образом, у нас всегда будут самые последние результаты при каждом запросе.
В идеале я бы добавил веб-сокет, который бы транслировал самые последние результаты, но это не входило в задачу.

## Использование

### Установка из исходников

1. Установите Ruby 3.x.x
2. Клонируйте репозиторий

```bash
git clone git@github.com:urumo/experiments_api.git
```

3. Установите зависимости

```bash
bundle install
```

4. Создайте базу данных

```bash
rails db:prepare
```

5. Запустите сервер

```bash
rails s
```

Все что остается - перейти на [localhost:3000](http://localhost:3000) чтобы увидеть личный кабинет администратора.

### Установка с Docker

1. Установите Docker
2. Скачайте образ

```bash
docker pull ghcr.io/urumo/experiments_api/experiments_api:latest
```

3. Запустите образ

```bash
docker run -p 3000:3000 ghcr.io/urumo/experiments_api/experiments_api:latest
```

Переменные окружения:

* POSTGRES_DB
* POSTGRES_USER
* POSTGRES_PASSWORD

Последняя сборка всегда развернута на моем личном сервере [svck.dev](https://ab.svck.dev)

## API

### Эксперименты

Я решил сделать часть API отдельным приложением от страницы администратора для будущего масштабирования.
Он находится в папке `vendor/Api`.
На данный момент все, что он делает, это добавляет один эндпойнт к серверу, которая, при наличии заголовка Device-Token(
UUID), возвращает устройство с его экспериментами.
Эндпойнт находится по адресу `/api/distribution` и принимает `GET` запросы с заголовком `Device-Token`, который должен
быть типа UUID.
Конечная точка Swagger находится по адресу `/api-docs` и доступна из основного приложения.
